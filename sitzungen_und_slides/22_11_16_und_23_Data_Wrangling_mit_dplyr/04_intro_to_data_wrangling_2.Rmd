---
title: "Einführung Data Wrangling mit dplyr: Tödliche Polizeischüsse in Deutschland"
author: "Moritz Valentino Donatello Matzner"
date: "Today"
output: html_document
---

```{r}
knitr::opts_chunk$set(message = F, 
                      warning = F, 
                      error = F, 
                      eval = T, 
                      out.height = "50%")
```

# dplyr

- Ist die go-to Bibliothek wenn es um das Manipulieren von Daten geht   

```{r eval=T}
#install.packages("dplyr")
library(dplyr)
```

# Datenimport 

```{r eval=T}
deadly_cops <- read.csv("../data/deadly_cops/polizeischuesse.csv")

deadly_cops_filtered <- deadly_cops %>%
  filter(!is.na(Alter))
```

## Die sechs Zentralen Funktionen 

- Filter Observationen nach Werten ```filter()```.
- Organisiere die Datenwerte ```arrange()```.
- Wähle Variablen mit ihrem Nahmen ```select()```.
- Erzeuge neue Variablen indem du Funktionen auf existierende Variablen anwendest ```mutate()```.
- Gruppiert Werte nach Merkmalen ```summarise()```.

***

>-  All diese Funktionen können in Kombination mit ```group_by()``` verwendet werden. Dadurch wird der *scope* der Funktion nicht auf das gesammte Datenset, sondern auf die einzelnen Gruppen angewendet.  
>- Ein weiterer zentraler Befehl ist der pipe operator: ```%>%````
>     + Er wird als "dann" ausgesprochen. 



***

START CODE 

Namen von Variablen 

## Names

```{r}
names(deadly_cops)
```

## Select 

- ```Select``` wählt Variablen aus
- Das erste Argument ist der Name des DF, die weiteren sind die Variablen 

```{r}
select(deadly_cops, Fall, Name)
```

## Filter

Mit ```filter()``` können Observationen nach ihren Werten gefilter werden. 
- Das erste Argument ist der Name des *dataframe*. Das zweite (und jedes weitere Argument) wird zum filtern verwendet. 


```{r}
filter(deadly_cops, Bundesland == "Berlin")
```

Wenn wir erst einzlene Variablen auswählen wollen und dann ihre Werte filtern wollen nutzen wir den Pipe operator 

```{r}
deadly_cops %>%
  select(Fall, Alter, Bundesland) %>%
  filter(Bundesland == "Berlin")

# wenn wir berlin und hamburg nutzen wollen 

deadly_cops %>%
  select(Fall, Alter, Bundesland) %>%
  filter(Bundesland == "Berlin" | Bundesland == "Hamburg")

# oder wir nutzen einen vektor 

bl_1 <- c("Berlin", "Hamburg")

deadly_cops %>%
  select(Fall, Alter, Bundesland) %>%
  filter(Bundesland %in% bl_1)
```

Was, wenn wir mehr filtern wollen? 

-> Erinner sich noch wer an logische Operatoren?

Vergleiche und Logische Operatoren 
>- Vergleich:  >, >=, <, <=, != (ungleich), == (gleich).
>- Logische Operatoren: & ist “und”, | ist “oder”, and ! is “nicht”. 
>- Ein weiteres wichtiges Instrument ist das Symbol ```%in%````
    + es checkt, ob die werte eines vektors vorkommen 

```{r}
filter(deadly_cops, 
       Bundesland %in% bl_1
       & Datum > "2000-01-01")
```

## Arrange 

- ```arrange()``` sortiert Spalten und Daten innerhalb der Spalten 
- Wenn wir zum beispiel das jüngste Opfer oben haben 

```{r}
arrange(deadly_cops, Alter)
```
## mutate

- ```mutate()``` addiert neue Variablen am Ende des Datensatzes

- hier berechnen wir zb das durchschnittsalter pro bundesland 

```{r}
deadly_cops %>%
  select(Fall, Alter, Bundesland) %>%
  filter(!is.na(Alter)) %>%
  group_by(Bundesland) %>%
  mutate(mean_age_bundesland = round(mean(Alter))
         )
```
## Summarise 

das ist aber nicht so übersichtlich!

das machen wir mit summarise, die rows collapsen 

warum gibt es keine ergebnisse? 
--> NAs sind noch inkludiert 
- das können wir über die funktion lernen 

```{r}
sum(is.na(deadly_cops$Alter))
```

```{r}
deadly_cops %>%
  group_by(Bundesland) %>%
  summarise(count= n()) %>%
  arrange(desc(count))
```


```{r}
deadly_cops %>%
  select(Fall, Alter, Bundesland) %>%
  summarise(mean_age = mean(Alter, na.rm=T),
            median_age = median(Alter, na.rm = T)
            ) 
```

##group_by

Oft interessiert uns, ob es eine varition zwischen einzlnen gruppen gibt 

Dafür gruppieren wir unseren Datensatz 


```{r}
df_cops_1 <- deadly_cops %>%
  select(Fall, Alter, Bundesland) %>%
  group_by(Bundesland) %>%
  summarise(mean_age = round(mean(Alter, na.rm = T), 0), 
            median_age = round(median(Alter, na.rm = T), 0), 
            sd_age = round(sd(Alter, na.rm = T)), 
            observations = n()) %>%
  arrange(median_age)

df_cops_1
```

gibt es eine entwicklung über zeit?

```{r}
deadly_cops %>%
  mutate(Datum_aggregiert = ifelse(Datum < "2000-01-01", 
                                   "vor_2000", 
                                   "nach_2000")) %>%
  group_by(Datum_aggregiert) %>%
  summarise(mean_age = mean(Alter, na.rm=T))


deadly_cops %>%
  select(Datum, Alter, Hinweise.auf.psychische.Ausnahmesituation) %>%
  mutate(Datum_aggregiert = case_when(Datum > "2020-01-01" ~ "2020er", 
                                      Datum > "2010-01-01" ~ "2010er", 
                                      Datum > "2000-01-01" ~ "2000er", 
                                      Datum > "1990-01-01" ~ "1990er", 
                                      Datum > "1980-01-01" ~ "1980er", 
                                      Datum > "1970-01-01" ~ "1970er"
                                      )
  ) %>%
  group_by(Datum_aggregiert, Hinweise.auf.psychische.Ausnahmesituation) 


```

wo ist das problem? --> data fängt bei 1976 an, keine gleichen zeitintervalle

```{r}
deadly_cops %>%
  group_by(Hinweise.auf.psychische.Ausnahmesituation) %>%
  summarise(anzahl = n())

# we have to recode! 

df_cops_psych <- deadly_cops %>%
  mutate(Hinweis_psych_ausnahme = case_when(Hinweise.auf.psychische.Ausnahmesituation == "Ja" ~ "Ja", 
                                            Hinweise.auf.psychische.Ausnahmesituation == "" ~ "Nein", 
                                            Hinweise.auf.psychische.Ausnahmesituation == "Nein" ~ "Nein")
  ) %>%
  mutate(Datum_aggregiert = case_when(Datum > "2020-01-01" ~ "2020er", 
                                      Datum > "2010-01-01" ~ "2010er", 
                                      Datum > "2000-01-01" ~ "2000er", 
                                      Datum > "1990-01-01" ~ "1990er", 
                                      Datum > "1980-01-01" ~ "1980er", 
                                      Datum > "1970-01-01" ~ "1970er"
                                      )
         ) %>%
  group_by(Datum_aggregiert, Hinweis_psych_ausnahme) %>%
  summarise(Anzahl = n()) 

df_cops_psych_2 <- tidyr::spread(df_cops_psych, key="Hinweis_psych_ausnahme", value="Anzahl") %>%
  mutate(percent = Ja/(Ja+Nein))

library(ggplot2)
ggplot(df_cops_psych_2) +
  geom_point(aes(x=Datum_aggregiert, 
                 y=percent), 
             size=2, color="Darkblue") +
  theme_minimal() +
  ggtitle(label="Hinweis auf Psychische Ausnahmesituationen seit 1976")

```

Ändert sich das nach Bundesland?

```{r}
df_cops_psych_3 <- deadly_cops %>%
  mutate(Hinweis_psych_ausnahme = case_when(Hinweise.auf.psychische.Ausnahmesituation == "Ja" ~ "Ja", 
                                            Hinweise.auf.psychische.Ausnahmesituation == "" ~ "Nein", 
                                            Hinweise.auf.psychische.Ausnahmesituation == "Nein" ~ "Nein")
  ) %>%
  group_by(Hinweis_psych_ausnahme, Bundesland) %>%
  summarise(Anzahl = n()) 


tidyr::spread(df_cops_psych_3, key="Hinweis_psych_ausnahme", value="Anzahl") %>%
  mutate(percent = Ja/(Ja+Nein)) %>%
  arrange(desc(percent))
```

oder: wurden mehr und mehr menschen erschosssen?

```{r}
shot_per_year <- deadly_cops %>%
  select(Fall, Datum) %>%
  mutate(Jahr = format(as.Date(Datum, "%Y-%m-%d"), "%Y")) %>%
  group_by(Jahr) %>%
  summarise(number_shot = n())

hist(shot_per_year$number_shot)
```
Warum ist das interessant? Weil wir uns jetzt die jahre anschauen würden, wo outlier sind um zu verstehen was da abgeht 

```{r}
shot_per_year %>%
  filter(number_shot > 15)
```



# Join Data 

- Oft haben wir Daten aus verschiedenen Datenquellen 

Wir können Datensätze miteinander verbinden 

The mutating joins add columns from y to x, matching rows based on the keys:

inner_join(): includes all rows in x and y.

left_join(): includes all rows in x.

right_join(): includes all rows in y.

full_join(): includes all rows in x or y.

```{r}
`?left_join()
```


```{r}
bl <- c("Nordrhein-Westfalen",	
"Bayern",	
"Baden-Württemberg", 
"Niedersachsen",	 
"Hessen",	
"Rheinland-Pfalz",	 
"Sachsen",	
"Berlin",	
"Schleswig-Holstein",
"Brandenburg",	
"Sachsen-Anhalt",	 
"Thüringen",	
"Hamburg",	
"Mecklenburg-Vorpommern",	
"Saarland",	
"Bremen")

einwohnerinnen <- c(17.926, 13.14, 11.103,8.003 ,6.293 , 4.098 ,4.057 , 3.664 , 	2.911 , 2.531 , 2.181 ,2.12 , 1.852 , 1.611 , 0.984 , 0.68)

df_bl_data <- data.frame(bl, einwohnerinnen)

write.csv(df_bl_data, "../data/demo_data_bundeslaender")
```

```{r}

df_bl_data <- read.csv("../data/demo_data_bundeslaender")

dc_bl <- deadly_cops %>%
  group_by(Bundesland) %>%
  filter(Datum > "1990-01-01") %>%
  summarise(count = n()) 

df_joined <- left_join(dc_bl, 
                       df_bl_data,
                       by=c("Bundesland"="bl"))

df_joined %>%
  mutate(average = round(count/einwohnerinnen)) %>%
  arrange(desc(average))
```



# Let's code :) 

```{r eval=F}
# mean and median by gender
deadly_cops %>%
  filter(!is.na(Alter)) %>%
  select(Fall, Alter, Geschlecht, Bundesland) %>%
  group_by(Geschlecht) %>%
  summarise(median_age = median(Alter), 
            mean_age = mean(Alter)
  )

# Victims by Bundesland
deadly_cops %>%
  select(Fall, Bundesland) %>%
  group_by(Bundesland) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) 

```

***

```{r eval=F}
# suspicion 
deadly_cops %>%
  select(Bundesland, Datum) %>%
  filter(Bundesland == "Sachsen" | Bundesland == "Bayern") %>%
  group_by(Bundesland) %>%
  summarise(min_datum = min(Datum))

# better for comparison
deadly_cops %>%
  select(Bundesland, Datum) %>%
  filter(Datum > "1990-01-01") %>%
  group_by(Bundesland) %>%
  summarise(count = n()) %>%
  arrange(desc(count))
```

